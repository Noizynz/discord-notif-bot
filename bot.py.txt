import discord
from discord.ext import commands
from discord import app_commands
import json
import os

DATA_FILE = "home.bot.json"

# Ø§Ú¯Ù‡ ÙØ§ÛŒÙ„ Ø¯ÛŒØªØ§ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø´ØªØŒ Ø¨Ø³Ø§Ø²Ø´
if not os.path.exists(DATA_FILE):
    with open(DATA_FILE, "w", encoding="utf-8") as f:
        json.dump({"panels": {}}, f, ensure_ascii=False, indent=2)

def save_data(data):
    with open(DATA_FILE, "w", encoding="utf-8") as f:
        json.dump(data, f, ensure_ascii=False, indent=2)

def load_data():
    with open(DATA_FILE, "r", encoding="utf-8") as f:
        return json.load(f)

intents = discord.Intents.default()
intents.message_content = True
bot = commands.Bot(command_prefix="!", intents=intents)

@bot.event
async def on_ready():
    print(f"âœ… ÙˆØ§Ø±Ø¯ Ø´Ø¯Ù… Ø¨Ù‡ Ø§Ú©Ø§Ù†Øª: {bot.user}")
    try:
        synced = await bot.tree.sync()
        print(f"ğŸ”„ {len(synced)} Ø¯Ø³ØªÙˆØ± Ø§Ø³Ù„Ø´ Ù‡Ù…Ú¯Ø§Ù… Ø´Ø¯.")
    except Exception as e:
        print(e)

# /help
@bot.tree.command(name="help", description="Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø¨Ø§Øª")
async def help_command(interaction: discord.Interaction):
    embed = discord.Embed(title="ğŸ“š Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø¯Ø³ØªÙˆØ±Ø§Øª", color=discord.Color.blue())
    embed.add_field(name="/panel", value="Ù…Ø¯ÛŒØ±ÛŒØª Ù¾Ù†Ù„â€ŒÙ‡Ø§ÛŒ Ø³Ø§Ø®ØªÙ‡â€ŒØ´Ø¯Ù‡", inline=False)
    embed.add_field(name="/newpanel", value="Ø³Ø§Ø®Øª Ù¾Ù†Ù„ Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ù†ÙˆØªÛŒÙ", inline=False)
    embed.add_field(name="/check", value="Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… ØªØ³Øª Ø§Ø² ÛŒÚ© Ù¾Ù†Ù„", inline=False)
    embed.add_field(name="/help", value="Ù†Ù…Ø§ÛŒØ´ Ø§ÛŒÙ† Ø±Ø§Ù‡Ù†Ù…Ø§", inline=False)
    await interaction.response.send_message(embed=embed, ephemeral=True)

# /newpanel
@bot.tree.command(name="newpanel", description="Ø³Ø§Ø®Øª Ù¾Ù†Ù„ Ø¬Ø¯ÛŒØ¯")
async def newpanel(interaction: discord.Interaction, name: str, service: str, link: str, webhook_json: str, channel: discord.TextChannel):
    data = load_data()
    guild_id = str(interaction.guild_id)
    if guild_id not in data["panels"]:
        data["panels"][guild_id] = []

    panel = {
        "name": name,
        "service": service,
        "link": link,
        "webhook_json": webhook_json,
        "channel_id": channel.id
    }
    data["panels"][guild_id].append(panel)
    save_data(data)

    embed = discord.Embed(title="âœ… Ù¾Ù†Ù„ Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯", color=discord.Color.green())
    embed.add_field(name="Ù†Ø§Ù… Ù¾Ù†Ù„", value=name, inline=False)
    embed.add_field(name="Ø³Ø±ÙˆÛŒØ³", value=service, inline=False)
    embed.add_field(name="Ù„ÛŒÙ†Ú©", value=link, inline=False)
    embed.add_field(name="Ú†Ù†Ù„ Ø§Ø±Ø³Ø§Ù„", value=channel.mention, inline=False)
    await interaction.response.send_message(embed=embed)

# /panel
@bot.tree.command(name="panel", description="Ù…Ø¯ÛŒØ±ÛŒØª Ù¾Ù†Ù„â€ŒÙ‡Ø§")
async def panel(interaction: discord.Interaction):
    data = load_data()
    guild_id = str(interaction.guild_id)
    if guild_id not in data["panels"] or len(data["panels"][guild_id]) == 0:
        await interaction.response.send_message(embed=discord.Embed(description="âŒ Ù‡ÛŒÚ† Ù¾Ù†Ù„ÛŒ Ø³Ø§Ø®ØªÙ‡ Ù†Ø´Ø¯Ù‡.", color=discord.Color.red()))
        return

    embed = discord.Embed(title="ğŸ“‹ Ù„ÛŒØ³Øª Ù¾Ù†Ù„â€ŒÙ‡Ø§", color=discord.Color.blue())
    for idx, panel in enumerate(data["panels"][guild_id], start=1):
        embed.add_field(
            name=f"{idx}. {panel['name']}",
            value=f"Ø³Ø±ÙˆÛŒØ³: {panel['service']}\nÙ„ÛŒÙ†Ú©: {panel['link']}\nÚ†Ù†Ù„: <#{panel['channel_id']}>",
            inline=False
        )
    await interaction.response.send_message(embed=embed)

# /check
@bot.tree.command(name="check", description="ØªØ³Øª ÛŒÚ© Ù¾Ù†Ù„")
async def check(interaction: discord.Interaction, panel_name: str):
    data = load_data()
    guild_id = str(interaction.guild_id)
    if guild_id not in data["panels"]:
        await interaction.response.send_message(embed=discord.Embed(description="âŒ Ù‡ÛŒÚ† Ù¾Ù†Ù„ÛŒ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯.", color=discord.Color.red()))
        return

    for panel in data["panels"][guild_id]:
        if panel["name"] == panel_name:
            channel = bot.get_channel(panel["channel_id"])
            if channel:
                embed = discord.Embed(title="ğŸ“¢ Ù¾ÛŒØ§Ù… ØªØ³Øª", description="Ø§ÛŒÙ† ÛŒÚ© Ù¾ÛŒØ§Ù… ØªØ³Øª Ø§Ø³Øª.", color=discord.Color.orange())
                embed.add_field(name="Ø³Ø±ÙˆÛŒØ³", value=panel["service"], inline=False)
                embed.add_field(name="Ù„ÛŒÙ†Ú©", value=panel["link"], inline=False)
                await channel.send(embed=embed)
                await interaction.response.send_message(embed=discord.Embed(description="âœ… Ù¾ÛŒØ§Ù… ØªØ³Øª Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯.", color=discord.Color.green()))
                return
    await interaction.response.send_message(embed=discord.Embed(description="âŒ Ù¾Ù†Ù„ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯.", color=discord.Color.red()))

bot.run(os.getenv("DISCORD_TOKEN"))
